#!/bin/bash

# shellcheck source=./lib/base_command
source "$(dirname "${BASH_SOURCE[0]}")/lib/base_command"
cd "$DIR" || exit

EXIT_CODE=0
HTTP_CODE_OPTION='--silent --write-out '%{http_code}' --output /dev/null'

## --- API Auth Admin
statusCode=$(
    curl $HTTP_CODE_OPTION "https://api.tmgnew.demo.code-pilots.ru/api/auth/login" \
      -H 'content-type: application/json' \
      --data '{"login":"admin@tmgn.ru","password":"admin"}'
  );

if [[ $statusCode == 502 ]]; then
  print_style "Backend API не отвечает ($statusCode)\n" "danger"
  EXIT_CODE=1
elif [[ $statusCode != 200 ]] ; then
  print_style "Проблема с авторизацией в Админке ($statusCode)\n" "danger"
  EXIT_CODE=1
fi

## --- Front Admin
statusCode=$(
    curl $HTTP_CODE_OPTION "https://admin.tmgnew.demo.code-pilots.ru"
  );

if [[ $statusCode != 200 ]]; then
  print_style "Не открывается фронтовая часть админки ($statusCode)\n" "danger"
  EXIT_CODE=1
fi

## --- Front Client Catalog
statusCode=$(
    curl $HTTP_CODE_OPTION "https://tmgnew.demo.code-pilots.ru/"
  );

if [[ $statusCode != 200 ]]; then
  print_style "Не открывается фронтовая часть каталога ($statusCode)\n" "danger"
  EXIT_CODE=1
fi

## --- Front Client Catalog MSK
statusCode=$(
    curl $HTTP_CODE_OPTION "https://msk.tmgnew.demo.code-pilots.ru/"
  );

if [[ $statusCode != 200 ]]; then
  print_style "Не открывается фронтовая часть каталога msk ($statusCode)\n" "danger"
  EXIT_CODE=1
fi

## --- File AWS service
statusCode=$(
    curl $HTTP_CODE_OPTION "https://files.tmgnew.demo.code-pilots.ru"
  );

if [[ $statusCode != 403 ]]; then
  print_style "Проблемы с сервис-хранилищем minio ($statusCode)\n" "danger"
  EXIT_CODE=1
fi

## --- Backend liip + minio (default photo)
statusCode=$(
    curl $HTTP_CODE_OPTION "https://api.tmgnew.demo.code-pilots.ru/media/cache/default_photos_thumb_200/images/product/card_medium.png"
  );

if [[ $statusCode != 200 ]]; then
  print_style "Не загрузилась дефолтная картинка категории ($statusCode)\n" "danger"
  EXIT_CODE=1
fi

if [[ $EXIT_CODE == 0 ]]; then
  print_style "Сервисы работают\n" "success"
fi
exit $EXIT_CODE
