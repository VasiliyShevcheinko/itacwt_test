#!/bin/bash

# shellcheck source=./lib/base_command
source "$(dirname "${BASH_SOURCE[0]}")/lib/base_command"
cd "$DIR" || exit

ENV_PATH="$DIR/.env"

# Generate $DB_PASS
DB_USER=$(grep '^DB_USER=' "$ENV_PATH" | cut -f 2 -d '=')
DB_NAME=$(grep '^DB_NAME=' "$ENV_PATH" | cut -f 2 -d '=')
if [ ${#1} -gt 1 ]; then
    DB_PASS=$1
else
    DB_PASS=$(LC_ALL=C tr -dc 'A-Za-z0-9!%_-' < /dev/urandom | head -c 13 ; echo)
fi
replace-env-var "DB_PASS" $DB_PASS $ENV_PATH
print_style "Новый пароль от БД обновлен в ${ENV_PATH}\n"

# Change $DB_PASS in pgsql
dbContainerStatus=$(cd "$DIR" && docker-compose ps | grep db | grep -E 'Up|running' | head -n 1)
if [ ${#dbContainerStatus} -gt 1 ]; then
    SQL_CHANGE_PASSWORD="\"ALTER USER $DB_USER WITH PASSWORD '$DB_PASS';\""
    docker-compose exec db bash -c "psql -U $DB_USER -c ${SQL_CHANGE_PASSWORD}" || exit
    print_style "Изменен пароль в pgsql для пользователя ${DB_USER}\n"
fi

docker-compose up -d
